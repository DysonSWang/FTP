name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '22'

    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Dependencies
      run: npm install

    - name: Setup Android
      uses: android-actions/setup-android@v3

    - name: Install Capacitor
      run: npm install @capacitor/core @capacitor/cli @capacitor/android

    - name: Fix Capacitor Java Version BEFORE sync
      run: |
        sed -i 's/VERSION_21/VERSION_17/g' node_modules/@capacitor/android/capacitor/build.gradle 2>/dev/null || true
        sed -i 's/VERSION21/VERSION17/g' node_modules/@capacitor/android/capacitor/build.gradle 2>/dev/null || true
        sed -i "s/= '21'/= '17'/g" node_modules/@capacitor/android/capacitor/build.gradle 2>/dev/null || true

    - name: Create www
      run: |
        mkdir -p www
        cp index.html www/
        cp policies-data.js www/
        cp knowledge-base.js www/

    - name: Init Capacitor
      run: |
        # 从 package.json 读取版本号
        VERSION=$(node -p "require('./package.json').version")
        VERSION_CODE=$(node -p "require('./package.json').versionCode || 1")
        
        cat > capacitor.config.json << EOF
        {
          "appId": "com.hainan.ftp.policy",
          "appName": "海南自贸港政策库",
          "version": "$VERSION",
          "versionCode": $VERSION_CODE,
          "webDir": "www",
          "bundledWebRuntime": false,
          "server": {
            "url": "http://120.48.16.193:5173",
            "cleartext": true
          },
          "android": {
            "allowMixedContent": true,
            "captureInput": true,
            "webContentsDebuggingEnabled": true
          }
        }
        EOF
        echo "✓ 创建 capacitor.config.json (版本：$VERSION, code: $VERSION_CODE)"

    - name: Add Android
      run: |
        rm -rf android
        npx cap add android

    - name: Create variables.gradle
      run: |
        cat > android/variables.gradle << 'EOF'
        ext {
            minSdkVersion = 22
            compileSdkVersion = 35
            targetSdkVersion = 35
            androidxActivityVersion = '1.8.0'
            androidxAppCompatVersion = '1.6.1'
            androidxCoordinatorLayoutVersion = '1.2.0'
            androidxCoreVersion = '1.12.0'
            androidxFragmentVersion = '1.6.2'
            coreSplashScreenVersion = '1.0.1'
            androidxWebkitVersion = '1.9.0'
            junitVersion = '4.13.2'
            androidxJunitVersion = '1.1.5'
            androidxEspressoCoreVersion = '3.5.1'
            cordovaAndroidVersion = '10.1.1'
        }
        EOF

    - name: Sync
      run: npx cap sync android

    - name: Setup gradle.properties
      run: |
        cd android
        cat > gradle.properties << 'EOF'
        org.gradle.java.home=/opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.18-8/x64
        android.useAndroidX=true
        android.enableJetifier=true
        org.gradle.jvmargs=-Xmx2048m
        EOF

    - name: Rewrite app/build.gradle
      run: |
        cd android
        echo "plugins {
            id 'com.android.application'
        }

        android {
            namespace 'com.hainan.ftp.policy'
            compileSdk 35

            defaultConfig {
                applicationId \"com.hainan.ftp.policy\"
                minSdk 22
                targetSdk 35
                versionCode 1
                versionName \"1.0\"
            }

            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
                debug {
                    debuggable true
                }
            }
        }

        dependencies {
            implementation fileTree(dir: 'libs', include: ['*.jar'])
            implementation project(':capacitor-android')
            implementation 'androidx.core:core-splashscreen:1.0.1'
            implementation 'androidx.webkit:webkit:1.9.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.11.0'
        }" > app/build.gradle
        echo "Rewrote app/build.gradle"
        grep -A2 "compileOptions" app/build.gradle

    - name: Add Network Security Config
      run: |
        cd android/app/src/main
        mkdir -p res/xml
        cat > res/xml/network_security_config.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <network-security-config>
            <base-config cleartextTrafficPermitted="true">
                <trust-anchors>
                    <certificates src="system" />
                </trust-anchors>
            </base-config>
            <domain-config cleartextTrafficPermitted="true">
                <domain includeSubdomains="true">120.48.16.193</domain>
                <domain includeSubdomains="true">localhost</domain>
            </domain-config>
        </network-security-config>
        EOF
        echo "✓ Created network_security_config.xml"

    - name: Update AndroidManifest.xml
      run: |
        cd android/app/src/main
        sed -i 's/<application/<application\n        android:networkSecurityConfig="@xml\/network_security_config"/' AndroidManifest.xml
        echo "✓ Updated AndroidManifest.xml"
        grep "networkSecurityConfig" AndroidManifest.xml

    - name: Build
      run: |
        cd android
        ./gradlew assembleDebug --no-daemon

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: hainan-policy-v1.0.0-build1
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
