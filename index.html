<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Hainan FTP Policy Database | æµ·å—è‡ªè´¸æ¸¯æ”¿ç­–åº“</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* å®‰å…¨åŒºåŸŸé€‚é… - åˆ˜æµ·å±/çµåŠ¨å²› */
        :root {
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }
        
        /* ç¦æ­¢æ°´å¹³æ»šåŠ¨å’Œæ‹‰åŠ¨æ•ˆæœ */
        html, body {
            overflow-x: hidden;
            overscroll-behavior: none;
            touch-action: pan-y;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px;
            padding-top: calc(20px + var(--safe-area-top));
            padding-bottom: calc(20px + var(--safe-area-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; padding: 20px 20px 30px; }
        header h1 { font-size: 1.8rem; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        header p { font-size: 0.95rem; opacity: 0.9; }
        
        /* è¯­è¨€åˆ‡æ¢å™¨ - å›ºå®šåœ¨é¡¶éƒ¨ */
        .lang-switcher { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0;
            background: rgba(102, 126, 234, 0.95); 
            backdrop-filter: blur(10px); 
            padding: calc(10px + var(--safe-area-top)) 20px 10px;
            display: flex; 
            justify-content: center;
            gap: 10px; 
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding-left: calc(20px + var(--safe-area-left));
            padding-right: calc(20px + var(--safe-area-right));
        }
        .lang-btn { 
            background: transparent; 
            border: 2px solid rgba(255,255,255,0.5); 
            color: white; 
            padding: 8px 16px; 
            min-width: 44px;
            min-height: 44px;
            border-radius: 22px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            transition: all 0.3s; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lang-btn:hover, .lang-btn.active { 
            background: white; 
            color: #667eea; 
            border-color: white; 
        }
        .lang-btn:active {
            transform: scale(0.95);
        }
        
        /* æœç´¢æ¡†ä¼˜åŒ– - æ›´å°æ›´ç®€æ´ */
        .search-box { 
            background: white; 
            border-radius: 25px; 
            padding: 8px 15px; 
            display: flex; 
            align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            margin: 15px auto; 
            max-width: 500px;
            gap: 8px;
        }
        .search-box input { 
            flex: 1; 
            border: none; 
            outline: none; 
            font-size: 0.9rem; 
            padding: 8px;
            min-width: 0;
            -webkit-appearance: none;
        }
        .search-box input:focus {
            background: #f8f9fa;
            border-radius: 20px;
        }
        .search-box button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            min-width: 44px;
            min-height: 44px;
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: transform 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-box button:hover { 
            transform: scale(1.05); 
        }
        .search-box button:active {
            transform: scale(0.95);
        }
        .search-box button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .category-tabs { display: flex; flex-wrap: wrap; gap: 10px; margin: 30px 0; justify-content: center; }
        .category-tab { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-size: 0.95rem; }
        .category-tab:hover, .category-tab.active { background: white; color: #667eea; border-color: white; }
        .policy-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 30px; }
        .policy-card { background: white; border-radius: 15px; padding: 25px; cursor: pointer; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .policy-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .category { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; display: inline-block; margin-bottom: 15px; }
        .policy-card h3 { color: #333; font-size: 1.2rem; margin-bottom: 10px; line-height: 1.4; }
        .policy-card p { color: #666; font-size: 0.95rem; line-height: 1.6; margin-bottom: 15px; }
        .meta { display: flex; justify-content: space-between; align-items: center; color: #999; font-size: 0.9rem; }
        .arrow { color: #667eea; font-weight: bold; transition: transform 0.3s; }
        .policy-card:hover .arrow { transform: translateX(5px); }
        .stats { display: flex; justify-content: center; gap: 40px; margin-top: 30px; }
        .stat-item { text-align: center; }
        .stat-item .number { display: block; font-size: 2rem; font-weight: bold; color: white; }
        .stat-item .label { font-size: 0.9rem; opacity: 0.9; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { 
            background: white; 
            border-radius: 20px; 
            max-width: 900px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }
        .modal-header { padding: 25px; border-bottom: 1px solid #e0e0e0; position: relative; }
        .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; transition: color 0.3s; }
        .modal-close:hover { color: #333; }
        .category-tag { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; display: inline-block; margin-bottom: 10px; }
        .modal-header h2 { color: #333; font-size: 1.5rem; margin-top: 10px; }
        .modal-body { padding: 25px; }
        .content-section { margin-bottom: 25px; }
        .content-section h3 { color: #667eea; font-size: 1.1rem; margin-bottom: 15px; }
        .content-section p, .content-section div { color: #555; line-height: 1.8; font-size: 0.95rem; }
        .highlight-box { background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .highlight-box strong { color: #667eea; }
        .policy-link-btn { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 10px; text-decoration: none; font-weight: 600; transition: transform 0.3s; margin: 15px 0; }
        .policy-link-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .related-questions-list { display: flex; flex-direction: column; gap: 10px; }
        .question-item { padding: 12px 15px; background: #f8f9fa; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
        .question-item:hover { background: #667eea; color: white; transform: translateX(5px); }
        .modal-footer { padding: 20px 25px; background: #f8f9fa; border-top: 1px solid #e0e0e0; display: flex; justify-content: space-between; font-size: 0.85rem; color: #999; }
        .modal-footer a { color: #667eea; text-decoration: none; }
        .robot-btn { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 50px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s; 
            z-index: 1500;
            font-size: 0.9rem;
        }
        .robot-btn:hover { 
            transform: scale(1.05); 
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); 
        }
        
        /* æœºå™¨äººé¢æ¿èƒŒæ™¯è’™ç‰ˆ */
        .robot-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1550;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .robot-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* æœºå™¨äººé¢æ¿ - ç§»åŠ¨ç«¯å…¨å± */
        .robot-panel { 
            display: none; 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0;
            top: 0;
            background: white; 
            z-index: 1600; 
            flex-direction: column; 
            overflow: hidden;
            touch-action: pan-y; 
            overscroll-behavior: contain;
        }
        .robot-panel.active { display: flex; }
        
        .robot-header { 
            padding: 15px 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-shrink: 0;
        }
        .robot-title { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 600;
            font-size: 1rem;
        }
        .robot-close { 
            background: rgba(255,255,255,0.2); 
            border: none; 
            color: white; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1.2rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: background 0.3s;
            flex-shrink: 0;
        }
        .robot-close:hover { background: rgba(255,255,255,0.3); }
        .robot-chat { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overscroll-behavior: contain;
        }
        
        /* ç¦æ­¢èŠå¤©å†…å®¹åŒºåŸŸæ‹‰åŠ¨çˆ¶å®¹å™¨ */
        .robot-chat * {
            touch-action: pan-y;
        }
        .robot-message { margin-bottom: 15px; display: flex; }
        .robot-message.user { justify-content: flex-end; }
        .robot-message .message-content { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; }
        .robot-message.user .message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .robot-message.bot .message-content { background: white; color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .robot-message.bot .message-content a { color: #667eea; text-decoration: underline; }
        .robot-message.bot .message-content strong { color: #667eea; font-weight: 600; }
        .robot-message.bot .message-content .chat-hr { border:none; border-top:1px solid #e0e0e0; margin:15px 0; display:block; }
        .suggested-question { cursor: pointer; padding: 8px 12px; margin: 5px 0; background: #f8f9fa; border-radius: 8px; transition: all 0.3s; display: block; }
        .suggested-question:hover { background: #667eea; color: white; transform: translateX(5px); }
        .typing-cursor { animation: blink 1s infinite; color: #667eea; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .message-actions { display: flex; gap: 8px; margin-top: 15px; padding-top: 12px; border-top: 1px solid #e0e0e0; }
        .action-btn { background: #f8f9fa; border: 1px solid #e0e0e0; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; color: #666; }
        .action-btn:hover { background: #667eea; color: white; border-color: #667eea; }
        .action-btn.voted { background: #667eea; color: white; border-color: #667eea; }
        .robot-input-area { padding: 15px; background: white; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; }
        .robot-input-area input { flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 0.95rem; outline: none; }
        .robot-input-area input:focus { border-color: #667eea; }
        .robot-input-area button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; cursor: pointer; font-weight: 600; }
        .robot-input-area button:hover { transform: scale(1.05); }
        .robot-typing { padding: 10px 20px; background: white; display: none; gap: 5px; }
        .robot-typing span { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: typing 1.4s infinite; }
        .robot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .robot-typing span:nth-child(3) { animation-delay: 0.4s; }
        .robot-footer { padding: 12px 20px; background: #f8f9fa; border-top: 1px solid #e0e0e0; font-size: 0.8rem; color: #999; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-10px); opacity: 1; } }
        
        /* ===== ç§»åŠ¨ç«¯å¢å¼ºä½“éªŒ ===== */
        
        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: calc(80px + var(--safe-area-bottom));
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 80%;
            text-align: center;
            pointer-events: none;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast.error {
            background: rgba(220, 53, 69, 0.9);
        }
        .toast.success {
            background: rgba(40, 167, 69, 0.9);
        }
        
        /* åŠ è½½éª¨æ¶å± */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* å¡ç‰‡ç‚¹å‡»åé¦ˆ */
        .policy-card {
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
        }
        .policy-card:active {
            transform: scale(0.98);
        }
        
        /* åˆ†ç±»æ ‡ç­¾ - æœ€å°è§¦æ‘¸åŒºåŸŸ */
        .category-tab {
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .category-tab:active {
            transform: scale(0.95);
        }
        
        /* æ”¿ç­–å¡ç‰‡ - ä¼˜åŒ–è§¦æ‘¸åŒºåŸŸ */
        .policy-card {
            min-height: 150px;
        }
        
        /* å…³é—­æŒ‰é’® - æœ€å° 44px */
        .modal-close, .robot-close {
            min-width: 44px;
            min-height: 44px;
        }
        
        /* è¾“å…¥æ¡† - é˜²æ­¢ iOS ç¼©æ”¾ */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* é“¾æ¥/æŒ‰é’® ç‚¹å‡»æ€ */
        a, button, .action-btn, .question-item, .suggested-question {
            -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            touch-action: manipulation;
        }
        a:active, button:active, .action-btn:active {
            opacity: 0.8;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
        
        /* é¡µé¢è¿‡æ¸¡åŠ¨ç”» */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ä¸Šæ‹‰åŠ¨ç”» */
        .slide-up {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* ä¸‹æ‹‰åˆ·æ–°æŒ‡ç¤ºå™¨ */
        .pull-refresh {
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            transition: top 0.3s;
        }
        .pull-refresh.active {
            top: 0;
        }
        
        /* ç½‘ç»œçŠ¶æ€æç¤º */
        .offline-banner {
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            background: rgba(255, 152, 0, 0.95);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
            z-index: 999;
            display: none;
        }
        .offline-banner.show {
            display: block;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) { 
            body { padding-top: 50px; }
            header h1 { font-size: 1.5rem; }
            header p { font-size: 0.85rem; }
            .stats { gap: 20px; }
            .stat-item .number { font-size: 1.5rem; }
            .stat-item .label { font-size: 0.8rem; }
            .search-box { padding: 6px 12px; margin: 10px auto; }
            .search-box input { font-size: 0.85rem; padding: 6px; }
            .search-box button { padding: 8px 16px; font-size: 0.85rem; }
            .category-tabs { gap: 8px; margin: 20px 0; }
            .category-tab { padding: 8px 16px; font-size: 0.85rem; }
            .policy-grid { grid-template-columns: 1fr; gap: 15px; }
            .policy-card { padding: 20px; }
            .robot-btn { bottom: 15px; right: 15px; padding: 10px 16px; }
            .robot-text { display: none; }
            /* ç§»åŠ¨ç«¯æœºå™¨äººå…¨å±ï¼Œä¸éœ€è¦é¢å¤–æ ·å¼ */
        }
    </style>
</head>
<body>
    <!-- Toast é€šçŸ¥ -->
    <div class="toast" id="toast"></div>
    
    <!-- ç¦»çº¿æç¤º -->
    <div class="offline-banner" id="offlineBanner">âš ï¸ å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨</div>
    
    <div class="lang-switcher">
        <button class="lang-btn active" onclick="switchLang('zh')" id="langZh">ä¸­æ–‡</button>
        <button class="lang-btn" onclick="switchLang('en')" id="langEn">English</button>
    </div>
    <div class="container">
        <header>
            <h1 id="pageTitle">ğŸŒ´ æµ·å—è‡ªç”±è´¸æ˜“æ¸¯æ”¿ç­–åº“</h1>
            <p id="pageSubtitle">ä¸€ç«™å¼æŸ¥è¯¢æµ·å—è‡ªè´¸æ¸¯æ ¸å¿ƒæ”¿ç­–åŠè§£è¯»</p>
            <div class="stats">
                <div class="stat-item"><span class="number" id="totalPolicies">60</span><span class="label" id="labelPolicies">æ ¸å¿ƒæ”¿ç­–</span></div>
                <div class="stat-item"><span class="number">8</span><span class="label" id="labelCategories">æ”¿ç­–ç±»åˆ«</span></div>
                <div class="stat-item"><span class="number">100%</span><span class="label" id="labelOfficial">å®˜æ–¹æ¥æº</span></div>
            </div>
        </header>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="æœç´¢æ”¿ç­–å…³é”®è¯...">
            <button onclick="searchPolicies()">ğŸ” <span id="btnSearch">æœç´¢</span></button>
        </div>
        <div class="category-tabs" id="categoryTabs"></div>
        <div class="policy-grid" id="policyGrid"></div>
    </div>
    <div class="robot-btn" id="robotBtn" onclick="toggleRobot()">
        <span>ğŸ¤–</span><span class="robot-text" id="robotBtnText">æ”¿ç­–åŠ©æ‰‹</span>
    </div>
    <div class="robot-overlay" id="robotOverlay" onclick="toggleRobot()"></div>
    <div class="robot-panel" id="robotPanel">
        <div class="robot-header">
            <div class="robot-title"><span>ğŸ¤–</span><span id="robotTitle">æµ·å—è‡ªè´¸æ¸¯æ”¿ç­– AI åŠ©æ‰‹</span></div>
            <button class="robot-close" onclick="toggleRobot()">&times;</button>
        </div>
        <div class="robot-chat" id="robotChat"></div>
        <div class="robot-input-area">
            <input type="text" id="robotInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="if(event.key==='Enter')sendRobotMessage()">
            <button onclick="sendRobotMessage()" id="robotSendBtn">å‘é€</button>
        </div>
        <div class="robot-typing" id="robotTyping"><span></span><span></span><span></span></div>
        <div class="robot-footer"><p id="robotDisclaimer">âš ï¸ <strong>å…è´£å£°æ˜</strong>ï¼šæœ¬åŠ©æ‰‹ç”± AI é©±åŠ¨ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæ³•å¾‹æˆ–ç¨åŠ¡å»ºè®®ã€‚</p></div>
    </div>
    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <span class="category-tag" id="modalCategory"></span>
                <h2 id="modalTitle"></h2>
            </div>
            <div class="modal-body">
                <div class="content-section"><h3>ğŸ“‹ <span id="labelContent">æ”¿ç­–å†…å®¹</span></h3><div id="modalContent"></div></div>
                <div class="content-section"><h3>ğŸ’¡ <span id="labelInterpretation">æ”¿ç­–è§£è¯»</span></h3><div id="modalInterpretation"></div></div>
                <div class="highlight-box" id="modalHighlight"><strong>ğŸ¯ <span id="labelHighlight">æ ¸å¿ƒè¦ç‚¹ï¼š</span></strong><span id="modalHighlightText"></span></div>
                <div class="content-section" id="modalLinkSection"><h3>ğŸ”— <span id="labelLink">æ”¿ç­–åŸæ–‡</span></h3><a id="modalPolicyLink" href="#" target="_blank" class="policy-link-btn"><span>ğŸ“„ <span id="btnViewPolicy">æŸ¥çœ‹å®˜æ–¹æ”¿ç­–åŸæ–‡</span></span><span>â†’</span></a></div>
                <div class="content-section" id="modalQuestionsSection"><h3>ğŸ’¬ <span id="labelQuestions">ç›¸å…³é—®é¢˜</span></h3><div id="modalRelatedQuestions" class="related-questions-list"></div></div>
            </div>
            <div class="modal-footer"><span id="labelSource">æ¥æºï¼š</span><a href="https://www.hnftp.gov.cn" target="_blank" id="modalSourceLink">æµ·å—è‡ªç”±è´¸æ˜“æ¸¯å®˜æ–¹ç½‘ç«™</a></div>
        </div>
    </div>
    <script src="policies-data.js" id="policies-script"></script>
    <script>
        // Global variables
        let currentLang = 'zh';
        let currentCategory = 'all';
        let searchQuery = '';
        let isRobotOpen = false;
        
        // Force reload policies-data.js with timestamp to avoid cache
        (function() {
            const script = document.getElementById('policies-script');
            if (script) {
                script.src = 'policies-data.js?t=' + Date.now();
            }
        })();

        // Translations
        const t = {
            zh: {
                pageTitle: 'ğŸŒ´ æµ·å—è‡ªç”±è´¸æ˜“æ¸¯æ”¿ç­–åº“', pageSubtitle: 'ä¸€ç«™å¼æŸ¥è¯¢æµ·å—è‡ªè´¸æ¸¯æ ¸å¿ƒæ”¿ç­–åŠè§£è¯»',
                labelPolicies: 'æ ¸å¿ƒæ”¿ç­–', labelCategories: 'æ”¿ç­–ç±»åˆ«', labelOfficial: 'å®˜æ–¹æ¥æº',
                searchPlaceholder: 'æœç´¢æ”¿ç­–å…³é”®è¯...', btnSearch: 'æœç´¢',
                robotBtnText: 'æ”¿ç­–åŠ©æ‰‹', robotTitle: 'æµ·å—è‡ªè´¸æ¸¯æ”¿ç­– AI åŠ©æ‰‹', btnSend: 'å‘é€', inputPlaceholder: 'è¾“å…¥æ‚¨çš„é—®é¢˜...',
                labelContent: 'æ”¿ç­–å†…å®¹', labelInterpretation: 'æ”¿ç­–è§£è¯»', labelHighlight: 'æ ¸å¿ƒè¦ç‚¹ï¼š',
                labelLink: 'æ”¿ç­–åŸæ–‡', btnViewPolicy: 'æŸ¥çœ‹å®˜æ–¹æ”¿ç­–åŸæ–‡ï¼ˆæ ¸å¿ƒæ”¿ç­– 60 æ¡ï¼‰',
                labelQuestions: 'ç›¸å…³é—®é¢˜', labelSource: 'æ¥æºï¼š', clickForDetails: 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…',
                modalDate: 'æ›´æ–°æ—¥æœŸï¼š2026-02-21',
                robotDisclaimer: 'âš ï¸ <strong>å…è´£å£°æ˜</strong>ï¼šæœ¬åŠ©æ‰‹ç”± AI é©±åŠ¨ï¼ŒåŸºäºæµ·å—è‡ªç”±è´¸æ˜“æ¸¯å…¬å¼€æ”¿ç­–ä¿¡æ¯æ•´ç†ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæ³•å¾‹æˆ–ç¨åŠ¡å»ºè®®ã€‚å…·ä½“æ”¿ç­–æ‰§è¡Œä»¥å®˜æ–¹æœ€æ–°æ–‡ä»¶ä¸ºå‡†ã€‚',
                robotGreeting: 'æ‚¨å¥½ï¼æˆ‘æ˜¯æµ·å—è‡ªè´¸æ¸¯æ”¿ç­– AI åŠ©æ‰‹ ğŸŒ´<br><br>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š<br>â€¢ è§£ç­”æ”¿ç­–ç–‘é—®<br>â€¢ æŸ¥è¯¢é€‚ç”¨æ”¿ç­–<br>â€¢ å¯¹æ¯”æ”¿ç­–å·®å¼‚<br>â€¢ æä¾›ç”³æŠ¥å»ºè®®<br><br>è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ',
                modalSourceLink: 'æµ·å—è‡ªç”±è´¸æ˜“æ¸¯å®˜æ–¹ç½‘ç«™',
                categories: {all:'å…¨éƒ¨',tax:'ç¨æ”¶ä¼˜æƒ ',trade:'è´¸æ˜“è‡ªç”±',investment:'æŠ•èµ„è‡ªç”±',finance:'é‡‘èå¼€æ”¾',personnel:'äººå‘˜æµåŠ¨',transport:'è¿è¾“è‡ªç”±',data:'æ•°æ®å®‰å…¨',industry:'äº§ä¸šå‘å±•'}
            },
            en: {
                pageTitle: 'ğŸŒ´ Hainan FTP Policy Database', pageSubtitle: 'One-stop query for Hainan FTP core policies and interpretations',
                labelPolicies: 'Core Policies', labelCategories: 'Categories', labelOfficial: 'Official Source',
                searchPlaceholder: 'Search policies...', btnSearch: 'Search',
                robotBtnText: 'Policy Assistant', robotTitle: 'Hainan FTP Policy AI Assistant', btnSend: 'Send', inputPlaceholder: 'Type your question...',
                labelContent: 'Policy Content', labelInterpretation: 'Policy Interpretation', labelHighlight: 'Key Points:',
                labelLink: 'Official Policy Document', btnViewPolicy: 'View Official Policy (60 Core Policies)',
                labelQuestions: 'Related Questions', labelSource: 'Source:', clickForDetails: 'Click for details',
                modalDate: 'Updated: 2026-02-21',
                robotDisclaimer: 'âš ï¸ <strong>Disclaimer</strong>: This assistant is AI-powered, based on publicly available Hainan FTP policy information, for reference only, does not constitute legal or tax advice. Please consult official sources for policy implementation.',
                robotGreeting: 'Hello! I\'m your Hainan FTP Policy AI Assistant ğŸŒ´<br><br>I can help you:<br>â€¢ Answer policy questions<br>â€¢ Find applicable policies<br>â€¢ Compare policies<br>â€¢ Provide application advice<br><br>How can I help you?',
                modalSourceLink: 'Hainan Free Trade Port Official Website',
                categories: {all:'All',tax:'Tax Incentives',trade:'Trade Freedom',investment:'Investment Freedom',finance:'Financial Opening-up',personnel:'Personnel Mobility',transport:'Transport Freedom',data:'Data Security',industry:'Industry Development'}
            }
        };

        // Language switch
        function switchLang(lang) {
            currentLang = lang;
            document.getElementById('langZh').classList.toggle('active', lang==='zh');
            document.getElementById('langEn').classList.toggle('active', lang==='en');
            console.log('ğŸŒ Switch to:', lang);
            
            const tr = t[lang];
            document.getElementById('pageTitle').innerHTML = tr.pageTitle;
            document.getElementById('pageSubtitle').textContent = tr.pageSubtitle;
            document.getElementById('labelPolicies').textContent = tr.labelPolicies;
            document.getElementById('labelCategories').textContent = tr.labelCategories;
            document.getElementById('labelOfficial').textContent = tr.labelOfficial;
            document.getElementById('searchInput').placeholder = tr.searchPlaceholder;
            document.getElementById('btnSearch').textContent = tr.btnSearch;
            document.getElementById('robotBtnText').textContent = tr.robotBtnText;
            document.getElementById('robotTitle').textContent = tr.robotTitle;
            document.getElementById('robotInput').placeholder = tr.inputPlaceholder;
            document.getElementById('robotSendBtn').textContent = tr.btnSend;
            document.getElementById('labelContent').textContent = tr.labelContent;
            document.getElementById('labelInterpretation').textContent = tr.labelInterpretation;
            document.getElementById('labelHighlight').textContent = tr.labelHighlight;
            document.getElementById('labelLink').textContent = tr.labelLink;
            document.getElementById('btnViewPolicy').textContent = tr.btnViewPolicy;
            document.getElementById('labelQuestions').textContent = tr.labelQuestions;
            document.getElementById('labelSource').textContent = tr.labelSource;
            document.getElementById('modalSourceLink').textContent = tr.modalSourceLink;
            document.getElementById('robotDisclaimer').innerHTML = tr.robotDisclaimer;
            // Update robot greeting if panel is open
            const chat = document.getElementById('robotChat');
            if (chat.children.length === 0) {
                addBotMessage(tr.robotGreeting);
            }
            renderCategories();
            renderPolicies();
        }

        // Render categories
        function renderCategories() {
            const tabs = document.getElementById('categoryTabs');
            const tr = t[currentLang].categories;
            tabs.innerHTML = Object.entries(tr).map(([key, val]) => 
                `<div class="category-tab ${key==='all'?'active':''}" data-category="${key}">${val}</div>`
            ).join('');
            tabs.querySelectorAll('.category-tab').forEach(tab => {
                tab.onclick = function() {
                    tabs.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    renderPolicies();
                };
            });
        }

        // Render policies
        function renderPolicies() {
            const grid = document.getElementById('policyGrid');
            let allData = (typeof allPolicies !== 'undefined' ? allPolicies : []);
            console.log('ğŸ“‹ renderPolicies - Lang:', currentLang, 'Total:', allData.length);
            
            let filtered = [...allData];
            if (currentCategory !== 'all') filtered = filtered.filter(p => p.category === currentCategory);
            if (searchQuery) filtered = filtered.filter(p => p.title.toLowerCase().includes(searchQuery.toLowerCase()) || p.summary.toLowerCase().includes(searchQuery.toLowerCase()));
            document.getElementById('totalPolicies').textContent = filtered.length;
            if (filtered.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:white;padding:60px;"><h2>ğŸ˜• No policies found</h2></div>'; return; }
            
            grid.innerHTML = filtered.map(p => {
                const isEn = currentLang === 'en';
                const cat = isEn && p.categoryNameEn ? p.categoryNameEn : p.categoryName;
                const title = isEn && p.titleEn ? p.titleEn : p.title;
                const summary = isEn && p.summaryEn ? p.summaryEn : p.summary;
                return `<div class="policy-card" data-id="${p.id}" onclick="handlePolicyClick(${p.id})"><span class="category">${cat}</span><h3>${title}</h3><p>${summary}</p><div class="meta"><span>${t[currentLang].clickForDetails}</span><span class="arrow">â†’</span></div></div>`;
            }).join('');
            console.log('âœ… Rendered', filtered.length, 'policies');
        }

        // Handle policy click - GLOBAL FUNCTION
        window.handlePolicyClick = function(id) {
            console.log('Clicked policy ID:', id);
            openModal(id);
        };

        // Search
        function searchPolicies() {
            const input = document.getElementById('searchInput');
            const btn = document.querySelector('.search-box button');
            searchQuery = input.value.trim();
            
            // è¾“å…¥éªŒè¯
            if (!searchQuery) {
                showToast('ğŸ” è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'info');
                input.focus();
                return;
            }
            
            // æŒ‰é’®åŠ è½½çŠ¶æ€
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'â³ æœç´¢ä¸­...';
            
            renderPolicies();
            
            // æ¢å¤æŒ‰é’®
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                // æ˜¾ç¤ºç»“æœæç¤º
                const count = document.querySelectorAll('.policy-card:not([style*="display: none"])').length;
                if (count > 0) {
                    showToast(`âœ… æ‰¾åˆ° ${count} æ¡ç›¸å…³æ”¿ç­–`, 'success');
                } else {
                    showToast('ğŸ˜… æœªæ‰¾åˆ°ç›¸å…³æ”¿ç­–', 'error');
                }
            }, 300);
        }
        document.getElementById('searchInput').onkeypress = function(e) { if(e.key==='Enter') searchPolicies(); };

        // Modal functions
        function openModal(id) {
            // Use allPolicies or policies
            const allPol = (typeof allPolicies !== 'undefined' ? allPolicies : (typeof policies !== 'undefined' ? policies : []));
            const p = allPol.find(x => x.id === id);
            if (!p) { console.error('Policy not found:', id); return; }
            const isEn = currentLang === 'en';
            console.log('Opening policy', id, 'Lang:', isEn ? 'EN' : 'ZH');
            console.log('Title EN:', p.titleEn ? 'exists' : 'missing');
            console.log('Content EN:', p.contentEn ? 'exists' : 'missing');
            document.getElementById('modalCategory').textContent = isEn && p.categoryNameEn ? p.categoryNameEn : p.categoryName;
            document.getElementById('modalTitle').textContent = isEn && p.titleEn ? p.titleEn : p.title;
            document.getElementById('modalContent').textContent = isEn && p.contentEn ? p.contentEn : p.content;
            document.getElementById('modalInterpretation').textContent = isEn && p.interpretationEn ? p.interpretationEn : p.interpretation;
            document.getElementById('modalHighlightText').textContent = isEn && p.highlightEn ? p.highlightEn : p.highlight;
            document.getElementById('modalPolicyLink').href = p.link;
            document.getElementById('modalLinkSection').style.display = 'block';
            if (p.relatedQuestions && p.relatedQuestions.length > 0) {
                document.getElementById('modalRelatedQuestions').innerHTML = p.relatedQuestions.map(q => {
                    const txt = typeof q === 'object' ? (isEn ? q.en : q.zh) : q;
                    const qForRobot = typeof q === 'object' ? (isEn ? q.en : q.zh) : q;
                    return `<div class="question-item" onclick="askRobot('${qForRobot.replace(/'/g,"\\'")}')">${txt}</div>`;
                }).join('');
                document.getElementById('modalQuestionsSection').style.display = 'block';
            } else {
                document.getElementById('modalQuestionsSection').style.display = 'none';
            }
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
        
        // ===== ç§»åŠ¨ç«¯å¢å¼ºåŠŸèƒ½ =====
        
        // Toast é€šçŸ¥
        let toastTimeout;
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ç½‘ç»œçŠ¶æ€ç›‘æ§
        function updateOnlineStatus() {
            const banner = document.getElementById('offlineBanner');
            if (navigator.onLine) {
                banner.classList.remove('show');
            } else {
                banner.classList.add('show');
                showToast('âš ï¸ ç½‘ç»œå·²æ–­å¼€', 'error');
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // è¾“å…¥æ¡†èšç„¦æ—¶é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.addEventListener('focusin', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                setTimeout(() => {
                    e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        });
        
        // Android è¿”å›é”®å¤„ç†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.key === 'Backspace') {
                if (isRobotOpen) {
                    e.preventDefault();
                    toggleRobot();
                } else if (document.getElementById('modalOverlay').classList.contains('active')) {
                    e.preventDefault();
                    closeModal();
                }
            }
        });

        // Robot functions
        function toggleRobot() {
            isRobotOpen = !isRobotOpen;
            const panel = document.getElementById('robotPanel');
            const overlay = document.getElementById('robotOverlay');
            
            if (isRobotOpen) {
                panel.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';  // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            } else {
                panel.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';  // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            }
            
            if (isRobotOpen && document.getElementById('robotChat').children.length === 0) {
                addBotMessage(t[currentLang].robotGreeting);
            }
        }

        function addBotMessage(html) {
            const chat = document.getElementById('robotChat');
            chat.innerHTML += `<div class="robot-message bot"><div class="message-content">${html}</div></div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        function addUserMessage(text) {
            const chat = document.getElementById('robotChat');
            chat.innerHTML += `<div class="robot-message user"><div class="message-content">${text}</div></div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        async function sendRobotMessage() {
            const input = document.getElementById('robotInput');
            const sendBtn = document.getElementById('robotSendBtn');
            const msg = input.value.trim();
            
            if (!msg) {
                showToast('ğŸ’¬ è¯·è¾“å…¥é—®é¢˜', 'info');
                input.focus();
                return;
            }
            
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!navigator.onLine) {
                showToast('âš ï¸ ç½‘ç»œå·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥è¿æ¥', 'error');
                return;
            }
            
            addUserMessage(msg);
            input.value = '';
            document.getElementById('robotTyping').style.display = 'flex';
            sendBtn.disabled = true;
            
            try {
                // Use streaming for better UX
                // ä½¿ç”¨ç»å¯¹è·¯å¾„æŒ‡å‘æœåŠ¡å™¨ï¼ˆAPK æ‰“åŒ…åä¹Ÿèƒ½è®¿é—®ï¼‰
                const API_BASE = window.location.hostname === 'localhost' 
                    ? 'http://localhost:5173' 
                    : 'http://120.48.16.193:5173';
                const res = await fetch(API_BASE + '/api/chat', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({message: msg, stream: true}),
                    timeout: 30000
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                // Create a new message div for streaming
                const chat = document.getElementById('robotChat');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'robot-message bot';
                const messageId = 'msg-' + Date.now();
                messageDiv.id = messageId;
                messageDiv.innerHTML = '<div class="message-content"></div>';
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
                
                const contentDiv = messageDiv.querySelector('.message-content');
                let fullContent = '';
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                
                // Slower streaming speed
                const STREAM_DELAY = 50; // ms between each chunk
                
                document.getElementById('robotTyping').style.display = 'none';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            try {
                                const data = JSON.parse(line.slice(5).trim());
                                
                                if (data.error) {
                                    contentDiv.innerHTML = 'âŒ Error: ' + data.error;
                                    break;
                                }
                                
                                if (data.done) {
                                    // Streaming complete, process final message
                                    fullContent = data.fullMessage || fullContent;
                                    // Parse Markdown and make questions clickable
                                    let html = fullContent;
                                    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                                    html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                                    html = html.replace(/---/g, '<hr class="chat-hr">');
                                    html = html.replace(/\n/g, '<br>');
                                    
                                    // Make related questions clickable
                                    const parts = html.split('<hr class="chat-hr">');
                                    if (parts.length >= 2) {
                                        const lastPart = parts[parts.length - 1];
                                        if (lastPart.includes('ğŸ’¡') || lastPart.includes('æ‚¨å¯èƒ½è¿˜æƒ³äº†è§£') || lastPart.includes('You may also want to know')) {
                                            // Match both with <br> and without (last question)
                                            let questionsHtml = lastPart.replace(/â€¢ ([^<]+)(<br>)?/g, function(match, question) {
                                                if (!question || question.trim() === '') return match;
                                                return '<div class="suggested-question" onclick="askRobot(\'' + question.replace(/'/g, "\\'") + '\')">â€¢ ' + question + '</div>';
                                            });
                                            parts[parts.length - 1] = questionsHtml;
                                            html = parts.join('<hr class="chat-hr">');
                                        }
                                    }
                                    
                                    // Add action buttons - use data attributes instead of onclick strings
                                    contentDiv.innerHTML = html;
                                    
                                    // Add action buttons after HTML is set
                                    const actionsDiv = document.createElement('div');
                                    actionsDiv.className = 'message-actions';
                                    actionsDiv.innerHTML = `
                                        <button class="action-btn" title="Copy">ğŸ“‹ å¤åˆ¶</button>
                                        <button class="action-btn" title="Helpful">ğŸ‘ æœ‰ç”¨</button>
                                        <button class="action-btn" title="Not helpful">ğŸ‘ éœ€æ”¹è¿›</button>
                                    `;
                                    
                                    // Add event listeners
                                    const buttons = actionsDiv.querySelectorAll('.action-btn');
                                    buttons[0].onclick = () => copyMessage(messageId);
                                    buttons[1].onclick = () => voteMessage(messageId, 'up');
                                    buttons[2].onclick = () => voteMessage(messageId, 'down');
                                    
                                    contentDiv.appendChild(actionsDiv);
                                    // Remove cursor after complete
                                    const cursor = contentDiv.querySelector('.typing-cursor');
                                    if (cursor) cursor.remove();
                                } else if (data.content) {
                                    // Append streaming content with delay
                                    await new Promise(r => setTimeout(r, STREAM_DELAY));
                                    fullContent += data.content;
                                    // Simple real-time rendering (will be replaced with full HTML at end)
                                    let displayContent = fullContent
                                        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                                        .replace(/\n/g, '<br>');
                                    contentDiv.innerHTML = displayContent + '<span class="typing-cursor">â–Š</span>';
                                }
                                
                                chat.scrollTop = chat.scrollHeight;
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }
                
                document.getElementById('robotSendBtn').disabled = false;
                
            } catch (e) {
                document.getElementById('robotTyping').style.display = 'none';
                document.getElementById('robotSendBtn').disabled = false;
                
                // å‹å¥½çš„é”™è¯¯æç¤º
                let errorMsg = 'ğŸ˜… è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•';
                if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                    errorMsg = 'âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ';
                } else if (e.message.includes('timeout')) {
                    errorMsg = 'â±ï¸ è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                }
                
                addBotMessage('âŒ ' + errorMsg);
                showToast(errorMsg, 'error');
                
                console.error('Robot error:', e);
            }
        }

        function askRobot(q) {
            // Close modal if open
            closeModal();
            // If robot is not open, open it first
            if (!isRobotOpen) {
                toggleRobot();
            }
            // Small delay to ensure robot is open before sending
            setTimeout(() => {
                document.getElementById('robotInput').value = q.trim();
                sendRobotMessage();
            }, 100);
        }

        // Get current/last user question for feedback context
        function getLastUserQuestion() {
            const userMessages = document.querySelectorAll('.robot-message.user');
            if (userMessages.length === 0) return '';
            return userMessages[userMessages.length - 1].innerText.trim();
        }

        // Copy message to clipboard - copy from start to end of references (exclude related questions)
        async function copyMessage(messageId) {
            console.log('Copy clicked, messageId:', messageId);
            const msgDiv = document.getElementById(messageId);
            if (!msgDiv) {
                console.error('Message div not found:', messageId);
                return;
            }
            
            // Get text content without HTML tags
            const contentDiv = msgDiv.querySelector('.message-content');
            if (!contentDiv) {
                console.error('Content div not found');
                return;
            }
            
            const fullText = contentDiv.innerText;
            const question = getLastUserQuestion();
            
            // Extract from start to end of references (exclude related questions after ğŸ’¡)
            let textToCopy = fullText;
            const cutIndex = fullText.indexOf('ğŸ’¡');
            
            if (cutIndex !== -1) {
                // Cut off everything from ğŸ’¡ onwards (related questions)
                textToCopy = fullText.substring(0, cutIndex).trim();
            }
            
            console.log('Copying (excluding related questions):', textToCopy.substring(0, 100), '...');
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(textToCopy);
                    console.log('Copy successful (modern API)');
                } else {
                    // Fallback for older browsers or non-HTTPS
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        console.log('Copy successful (execCommand fallback)');
                    } catch (e) {
                        throw new Error('execCommand also failed');
                    }
                    document.body.removeChild(textarea);
                }
                
                // Send feedback to backend
                fetch('/api/feedback', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'copy',
                        messageId: messageId,
                        question: question
                    })
                }).catch(e => console.error('Feedback error:', e));
                
                // Show success feedback
                const btn = msgDiv.querySelector('.action-btn:first-child');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                    btn.style.background = '#4CAF50';
                    btn.style.color = 'white';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 2000);
                }
            } catch (err) {
                console.error('Copy failed:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
        }

        // Vote message (up or down)
        async function voteMessage(messageId, type) {
            const msgDiv = document.getElementById(messageId);
            if (!msgDiv) return;
            
            const upBtn = msgDiv.querySelector('.action-btn:nth-child(2)');
            const downBtn = msgDiv.querySelector('.action-btn:nth-child(3)');
            const question = getLastUserQuestion();
            
            // Toggle vote
            if (type === 'up') {
                if (upBtn.classList.contains('voted')) {
                    upBtn.classList.remove('voted');
                    upBtn.innerHTML = 'ğŸ‘ æœ‰ç”¨';
                    // Send unvote to backend
                    fetch('/api/feedback', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: 'unvote',
                            messageId: messageId,
                            question: question
                        })
                    }).catch(e => console.error('Feedback error:', e));
                } else {
                    upBtn.classList.add('voted');
                    upBtn.innerHTML = 'âœ… å·²ç‚¹èµ';
                    downBtn.classList.remove('voted');
                    downBtn.innerHTML = 'ğŸ‘ éœ€æ”¹è¿›';
                    // Send vote to backend
                    fetch('/api/feedback', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: 'up',
                            messageId: messageId,
                            question: question
                        })
                    }).catch(e => console.error('Feedback error:', e));
                }
            } else if (type === 'down') {
                if (downBtn.classList.contains('voted')) {
                    downBtn.classList.remove('voted');
                    downBtn.innerHTML = 'ğŸ‘ éœ€æ”¹è¿›';
                    // Send unvote to backend
                    fetch('/api/feedback', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: 'unvote',
                            messageId: messageId,
                            question: question
                        })
                    }).catch(e => console.error('Feedback error:', e));
                } else {
                    downBtn.classList.add('voted');
                    downBtn.innerHTML = 'âœ… å·²åé¦ˆ';
                    upBtn.classList.remove('voted');
                    upBtn.innerHTML = 'ğŸ‘ æœ‰ç”¨';
                    // Send vote to backend
                    fetch('/api/feedback', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: 'down',
                            messageId: messageId,
                            question: question
                        })
                    }).catch(e => console.error('Feedback error:', e));
                }
            }
        }

        // Detect question language and set AI language context
        function detectLanguage(text) {
            // Simple detection: if contains Chinese characters, it's Chinese
            return /[\u4e00-\u9fa5]/.test(text) ? 'zh' : 'en';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, policies count:', typeof policies !== 'undefined' ? policies.length : 'undefined');
            renderCategories();
            renderPolicies();
        });
    </script>
</body>
</html>
